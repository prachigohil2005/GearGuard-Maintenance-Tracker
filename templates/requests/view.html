{% extends "base.html" %}

{% block title %}Request #{{ request.id }} - GearGuard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="page-header">
        <div>
            <a href="{{ url_for('requests.list_requests') }}" class="back-link">← Back to Requests</a>
            <h1>Request #{{ request.id }}: {{ request.subject }}</h1>
        </div>
        <div class="header-actions">
            {% if current_user.is_manager() or request.created_by_id == current_user.id or request.assigned_technician_id == current_user.id %}
            <a href="{{ url_for('requests.edit', id=request.id) }}" class="btn btn-secondary">Edit</a>
            {% endif %}
        </div>
    </div>
    
    <div class="detail-container">
        <!-- Request Details -->
        <div class="detail-card">
            <h2>Request Details</h2>
            
            <div class="status-actions">
                <form method="POST" action="{{ url_for('requests.update_status', id=request.id) }}" style="display: inline;">
                    <label>Status:</label>
                    <select name="status" class="form-control" style="width: auto; display: inline-block;" onchange="this.form.submit()">
                        <option value="New" {% if request.status == 'New' %}selected{% endif %}>New</option>
                        <option value="In Progress" {% if request.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                        <option value="Repaired" {% if request.status == 'Repaired' %}selected{% endif %}>Repaired</option>
                        <option value="Scrap" {% if request.status == 'Scrap' %}selected{% endif %}>Scrap</option>
                    </select>
                </form>
            </div>
            
            <div class="detail-grid">
                <div class="detail-item">
                    <label>Subject</label>
                    <p>{{ request.subject }}</p>
                </div>
                
                <div class="detail-item">
                    <label>Type</label>
                    <p><span class="badge badge-{{ 'warning' if request.request_type == 'Corrective' else 'info' }}">{{ request.request_type }}</span></p>
                </div>
                
                <div class="detail-item">
                    <label>Equipment</label>
                    <p><a href="{{ url_for('equipment.view', id=request.equipment_id) }}">{{ request.equipment.name }}</a></p>
                </div>
                
                <div class="detail-item">
                    <label>Team</label>
                    <p><a href="{{ url_for('teams.view', id=request.team_id) }}">{{ request.team.name }}</a></p>
                </div>
                
                <div class="detail-item">
                    <label>Created By</label>
                    <p>{{ request.created_by.name }}</p>
                </div>
                
                <div class="detail-item">
                    <label>Created At</label>
                    <p>{{ request.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                </div>
                
                <div class="detail-item">
                    <label>Due Date</label>
                    <p>{{ request.due_date.strftime('%Y-%m-%d') if request.due_date else '-' }}
                    {% if request.is_overdue() %}<span class="text-danger"> ⚠️ OVERDUE</span>{% endif %}
                    </p>
                </div>
                
                <div class="detail-item">
                    <label>Scheduled Date</label>
                    <p>{{ request.scheduled_date.strftime('%Y-%m-%d') if request.scheduled_date else '-' }}</p>
                </div>
                
                <div class="detail-item">
                    <label>Duration (Hours)</label>
                    <p>{{ request.duration if request.duration else '-' }}</p>
                </div>
            </div>
            
            <div class="detail-item full-width">
                <label>Description</label>
                <p>{{ request.description }}</p>
            </div>
            
            {% if request.notes %}
            <div class="detail-item full-width">
                <label>Notes</label>
                <p style="white-space: pre-line;">{{ request.notes }}</p>
            </div>
            {% endif %}
        </div>
        
        <!-- Technician Assignment -->
        <div class="detail-card">
            <h2>Technician Assignment</h2>
            
            {% if request.assigned_technician %}
            <div class="assigned-tech">
                <div class="tech-avatar">{{ request.assigned_technician.name[0] }}</div>
                <div class="tech-info">
                    <strong>{{ request.assigned_technician.name }}</strong>
                    <p>{{ request.assigned_technician.role }}</p>
                </div>
            </div>
            {% else %}
            <p class="text-muted">No technician assigned yet.</p>
            {% endif %}
            
            {% if request.status in ['New', 'In Progress'] %}
            <form method="POST" action="{{ url_for('requests.assign', id=request.id) }}" class="mt-3">
                <div class="form-group">
                    <label for="technician_id">Assign/Change Technician</label>
                    <select name="technician_id" class="form-control" required>
                        {% for tech in technicians %}
                        <option value="{{ tech.id }}" {% if request.assigned_technician_id == tech.id %}selected{% endif %}>
                            {{ tech.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Assign Technician</button>
            </form>
            {% endif %}
        </div>
        
        <!-- Delete Request -->
        {% if current_user.is_admin() or request.created_by_id == current_user.id %}
        <div class="detail-card">
            <h2>Danger Zone</h2>
            <form method="POST" action="{{ url_for('requests.delete', id=request.id) }}" 
                  onsubmit="return confirm('Are you sure you want to delete this request? This cannot be undone.');">
                <button type="submit" class="btn btn-danger">Delete Request</button>
            </form>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
